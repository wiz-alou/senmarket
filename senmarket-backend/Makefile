# ============================================
# Makefile - SENMARKET AVEC REDIS COMPLET
# ============================================

# Variables
APP_NAME := senmarket
DOCKER_COMPOSE := docker-compose
GO_FILES := $(shell find . -name "*.go" -type f)
REDIS_HOST := localhost
REDIS_PORT := 6379
REDIS_PASSWORD := 
DB_URL := postgres://senmarket:senmarket123@localhost:5432/senmarket?sslmode=disable

# ============================================
# ğŸ“‹ AIDE
# ============================================
.PHONY: help
help: ## Affiche l'aide
	@echo "ğŸ‡¸ğŸ‡³ SenMarket - Commandes Disponibles"
	@echo "===================================="
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-30s\033[0m %s\n", $$1, $$2}'
	@echo ""
	@echo "ğŸ”´ Commandes Redis spÃ©cialisÃ©es :"
	@echo "  make redis-start        - DÃ©marre Redis"
	@echo "  make redis-test         - Tests Redis complets"
	@echo "  make redis-monitor      - Monitoring temps rÃ©el"
	@echo "  make redis-dashboard    - Dashboard web"
	@echo "  make cache-warmup       - PrÃ©chauffage cache"
	@echo ""
	@echo "ğŸš€ Commandes rapides :"
	@echo "  make dev                - Environnement complet"
	@echo "  make dev-redis          - Dev avec Redis"
	@echo "  make monitor-all        - Monitoring complet"

# ============================================
# ğŸ”¨ BUILD & RUN
# ============================================
.PHONY: build run test test-coverage clean fmt lint deps

build: ## Compile l'application
	@echo "ğŸ”¨ Compilation de l'application..."
	@go build -o bin/$(APP_NAME) cmd/server/main.go
	@echo "âœ… Application compilÃ©e dans bin/$(APP_NAME)"

run: ## Lance l'application en mode dÃ©veloppement
	@echo "ğŸš€ Lancement de l'application..."
	@go run cmd/server/main.go

test: ## Lance les tests
	@echo "ğŸ§ª ExÃ©cution des tests..."
	@go test -v ./...

test-coverage: ## Lance les tests avec coverage
	@echo "ğŸ“Š Tests avec coverage..."
	@go test -coverprofile=coverage.out ./...
	@go tool cover -html=coverage.out -o coverage.html
	@echo "ğŸ“Š Coverage report: coverage.html"

clean: ## Nettoie les fichiers de build
	@echo "ğŸ§¹ Nettoyage..."
	@rm -rf bin/ tmp/ coverage.out coverage.html
	@echo "âœ… Nettoyage terminÃ©"

fmt: ## Formate le code
	@echo "âœ¨ Formatage du code..."
	@go fmt ./...
	@echo "âœ… Code formatÃ©"

lint: ## Lance le linter
	@echo "ğŸ” Linting..."
	@golangci-lint run
	@echo "âœ… Linting terminÃ©"

deps: ## Installe les dÃ©pendances
	@echo "ğŸ“¦ Installation des dÃ©pendances..."
	@go mod tidy
	@go mod download
	@echo "âœ… DÃ©pendances installÃ©es"

# ============================================
# ğŸ³ DOCKER
# ============================================
.PHONY: docker-up docker-down docker-logs docker-build docker-clean

docker-up: ## Lance les services Docker
	@echo "ğŸ³ Lancement des services Docker..."
	@$(DOCKER_COMPOSE) up -d
	@echo "âœ… Services Docker dÃ©marrÃ©s"
	@echo "ğŸ” Health check: http://localhost:8080/health"

docker-down: ## ArrÃªte les services Docker
	@echo "ğŸ›‘ ArrÃªt des services Docker..."
	@$(DOCKER_COMPOSE) down
	@echo "âœ… Services Docker arrÃªtÃ©s"

docker-logs: ## Affiche les logs Docker
	@$(DOCKER_COMPOSE) logs -f

docker-build: ## Rebuild les images Docker
	@echo "ğŸ”¨ Rebuild des images Docker..."
	@$(DOCKER_COMPOSE) build --no-cache
	@echo "âœ… Images Docker rebuilt"

docker-clean: ## Nettoie Docker complÃ¨tement
	@echo "ğŸ§¹ Nettoyage Docker..."
	@$(DOCKER_COMPOSE) down -v --remove-orphans
	@docker system prune -f
	@echo "âœ… Docker nettoyÃ©"

# ============================================
# ğŸ”´ REDIS CORE
# ============================================
.PHONY: redis-start redis-stop redis-restart redis-status redis-cli

redis-start: ## DÃ©marre Redis
	@echo "ğŸ”´ DÃ©marrage Redis..."
	@$(DOCKER_COMPOSE) up redis -d
	@echo "âœ… Redis dÃ©marrÃ©"
	@echo "ğŸ”— Redis: $(REDIS_HOST):$(REDIS_PORT)"

redis-stop: ## ArrÃªte Redis
	@echo "ğŸ”´ ArrÃªt Redis..."
	@$(DOCKER_COMPOSE) stop redis
	@echo "âœ… Redis arrÃªtÃ©"

redis-restart: ## RedÃ©marre Redis
	@echo "ğŸ”„ RedÃ©marrage Redis..."
	@$(DOCKER_COMPOSE) restart redis
	@echo "âœ… Redis redÃ©marrÃ©"

redis-status: ## Status Redis
	@echo "ğŸ”´ Status Redis..."
	@docker exec senmarket_redis redis-cli ping || echo "âŒ Redis non accessible"
	@echo "ğŸ“Š Infos Redis:"
	@docker exec senmarket_redis redis-cli info server | grep redis_version || true
	@docker exec senmarket_redis redis-cli dbsize || true

redis-cli: ## Console Redis interactive
	@echo "ğŸ”´ Console Redis (tapez 'exit' pour quitter)..."
	@docker exec -it senmarket_redis redis-cli

# ============================================
# ğŸ§ª REDIS TESTING
# ============================================
.PHONY: redis-test redis-test-short redis-perf redis-benchmark

redis-test: ## Tests Redis complets (15+ scenarios)
	@echo "ğŸ”´ Tests Redis complets..."
	@chmod +x scripts/validate_redis_implementation.sh
	@./scripts/validate_redis_implementation.sh

redis-test-short: ## Tests Redis rapides
	@echo "ğŸ”´ Tests Redis rapides..."
	@echo "1. Test connexion..."
	@curl -s http://localhost:8080/health | grep -q "redis.*UP" && echo "âœ… Redis UP" || echo "âŒ Redis DOWN"
	@echo "2. Test cache..."
	@curl -s http://localhost:8080/api/v1/categories > /dev/null && echo "âœ… Cache fonctionnel" || echo "âŒ Cache KO"
	@echo "3. Test rate limiting..."
	@for i in {1..5}; do curl -s http://localhost:8080/api/v1/categories > /dev/null; done && echo "âœ… Rate limiting OK" || echo "âŒ Rate limiting KO"

redis-perf: ## Tests performance Redis
	@echo "ğŸ”¥ Tests performance Redis..."
	@chmod +x scripts/redis_performance_test.sh
	@./scripts/redis_performance_test.sh

redis-benchmark: ## Benchmark Redis natif
	@echo "âš¡ Benchmark Redis..."
	@docker exec senmarket_redis redis-benchmark -q -n 1000 -c 10

# ============================================
# ğŸ“Š REDIS MONITORING
# ============================================
.PHONY: redis-monitor redis-stats redis-keys redis-memory redis-dashboard

redis-monitor: ## Monitoring Redis temps rÃ©el
	@echo "ğŸ”´ Monitoring Redis temps rÃ©el..."
	@chmod +x scripts/redis_monitor.sh
	@./scripts/redis_monitor.sh

redis-stats: ## Statistiques Redis
	@echo "ğŸ“Š Statistiques Redis..."
	@echo "ğŸ”‘ Nombre de clÃ©s:"
	@docker exec senmarket_redis redis-cli dbsize
	@echo "ğŸ’¾ MÃ©moire utilisÃ©e:"
	@docker exec senmarket_redis redis-cli info memory | grep used_memory_human
	@echo "ğŸ“ˆ Hit ratio:"
	@docker exec senmarket_redis redis-cli info stats | grep keyspace_hits
	@docker exec senmarket_redis redis-cli info stats | grep keyspace_misses

redis-keys: ## Voir les clÃ©s Redis par pattern
	@echo "ğŸ”‘ ClÃ©s Redis par type..."
	@echo "ğŸ“‹ Listings: $$(docker exec senmarket_redis redis-cli --scan --pattern 'listing:*' | wc -l)"
	@echo "ğŸ“‚ Categories: $$(docker exec senmarket_redis redis-cli --scan --pattern 'category:*' | wc -l)"
	@echo "ğŸ” Searches: $$(docker exec senmarket_redis redis-cli --scan --pattern 'search:*' | wc -l)"
	@echo "ğŸ‘¤ Users: $$(docker exec senmarket_redis redis-cli --scan --pattern 'user:*' | wc -l)"
	@echo "ğŸ“Š Stats: $$(docker exec senmarket_redis redis-cli --scan --pattern 'stats:*' | wc -l)"

redis-memory: ## Analyse mÃ©moire Redis
	@echo "ğŸ’¾ Analyse mÃ©moire Redis..."
	@docker exec senmarket_redis redis-cli info memory

redis-dashboard: ## Dashboard Redis web
	@echo "ğŸ“Š Ouverture dashboard Redis..."
	@echo "ğŸŒ Dashboard disponible Ã : file://$(PWD)/scripts/redis_dashboard.html"
	@echo "ğŸš€ DÃ©marrage serveur web local..."
	@python3 -m http.server 8082 -d scripts/ > /dev/null 2>&1 &
	@sleep 2
	@echo "ğŸ“Š Dashboard: http://localhost:8082/redis_dashboard.html"
	@echo "ğŸ’¡ Appuyez sur Ctrl+C pour arrÃªter le serveur"

# ============================================
# ğŸ—„ï¸ REDIS CACHE MANAGEMENT
# ============================================
.PHONY: cache-warmup cache-clear cache-clear-pattern cache-info cache-backup

cache-warmup: ## PrÃ©chauffage cache
	@echo "ğŸ”¥ PrÃ©chauffage cache..."
	@go run scripts/cache_warmup.go
	@echo "âœ… Cache prÃ©chauffÃ©"

cache-clear: ## Vide tout le cache Redis
	@echo "ğŸ§¹ Nettoyage cache Redis..."
	@docker exec senmarket_redis redis-cli flushall
	@echo "âœ… Cache vidÃ©"

cache-clear-pattern: ## Vide cache par pattern (usage: make cache-clear-pattern PATTERN=listing:*)
	@echo "ğŸ§¹ Nettoyage cache pattern: $(PATTERN)"
	@docker exec senmarket_redis redis-cli eval "return redis.call('del', unpack(redis.call('keys', ARGV[1])))" 0 "$(PATTERN)"
	@echo "âœ… Pattern $(PATTERN) supprimÃ©"

cache-info: ## Informations cache
	@echo "â„¹ï¸  Informations cache Redis..."
	@curl -s http://localhost:8080/api/v1/cache/stats | jq . || echo "âš ï¸  API non accessible"

cache-backup: ## Backup Redis
	@echo "ğŸ’¾ Backup Redis..."
	@chmod +x scripts/redis_backup.sh
	@./scripts/redis_backup.sh

# ============================================
# ğŸ—ƒï¸ DATABASE MIGRATIONS
# ============================================
.PHONY: migrate-up migrate-down migrate-create migrate-reset migrate-redis

migrate-up: ## Applique les migrations
	@echo "ğŸ“Š Application des migrations..."
	@migrate -path migrations -database "$(DB_URL)" up
	@echo "âœ… Migrations appliquÃ©es"

migrate-down: ## Annule les migrations
	@echo "â†©ï¸  Annulation des migrations..."
	@migrate -path migrations -database "$(DB_URL)" down
	@echo "âœ… Migrations annulÃ©es"

migrate-create: ## CrÃ©e une nouvelle migration (usage: make migrate-create NAME=nom_migration)
	@echo "ğŸ“ CrÃ©ation migration: $(NAME)"
	@migrate create -ext sql -dir migrations $(NAME)
	@echo "âœ… Migration crÃ©Ã©e"

migrate-reset: ## Reset complet DB + migrations
	@echo "ğŸ”„ Reset complet base de donnÃ©es..."
	@$(DOCKER_COMPOSE) down postgres
	@docker volume rm senmarket_postgres_data || true
	@$(DOCKER_COMPOSE) up postgres -d
	@sleep 5
	@make migrate-up
	@echo "âœ… Base de donnÃ©es reset"

migrate-redis: ## Applique les optimisations Redis DB
	@echo "ğŸ”´ Application optimisations Redis..."
	@migrate -path migrations -database "$(DB_URL)" up
	@echo "âœ… Optimisations Redis appliquÃ©es"

# ============================================
# ğŸ› ï¸ TOOLS & SETUP
# ============================================
.PHONY: install-tools setup-dev setup-prod

install-tools: ## Installe les outils de dÃ©veloppement
	@echo "ğŸ› ï¸  Installation des outils..."
	@go install github.com/cosmtrek/air@latest
	@go install -tags 'postgres' github.com/golang-migrate/migrate/v4/cmd/migrate@latest
	@echo "âœ… Outils installÃ©s"

setup-dev: ## Setup environnement dÃ©veloppement
	@echo "ğŸš€ Setup environnement dÃ©veloppement..."
	@make install-tools
	@make deps
	@echo "ğŸ“ CrÃ©ation dossiers..."
	@mkdir -p uploads backups/redis scripts logs
	@echo "ğŸ”§ Configuration .env..."
	@cp .env.example .env 2>/dev/null || echo "âš ï¸  .env.example non trouvÃ©"
	@echo "âœ… Environnement dev prÃªt"

setup-prod: ## Setup environnement production
	@echo "ğŸ­ Setup environnement production..."
	@echo "ğŸ”’ Configuration sÃ©curitÃ©..."
	@echo "âš ï¸  Assurez-vous de configurer :"
	@echo "  - Variables d'environnement sÃ©curisÃ©es"
	@echo "  - Certificats SSL"
	@echo "  - Firewall"
	@echo "  - Monitoring"

# ============================================
# ğŸ”„ HOT RELOAD
# ============================================
.PHONY: air dev-watch

air: ## Lance l'application avec hot reload
	@echo "ğŸ”¥ DÃ©marrage hot reload..."
	@air

dev-watch: ## DÃ©veloppement avec watch des fichiers
	@echo "ğŸ‘€ Mode dÃ©veloppement avec watch..."
	@make docker-up
	@make air

# ============================================
# ğŸš€ ENVIRONNEMENTS COMBINÃ‰S
# ============================================
.PHONY: dev dev-redis dev-full monitor-all prod-deploy

dev: docker-up ## Lance l'environnement de dÃ©veloppement
	@echo "ğŸš€ Environnement de dÃ©veloppement prÃªt !"
	@echo "ğŸ“Š PostgreSQL: localhost:5432"
	@echo "ğŸ”´ Redis: localhost:6379"
	@echo "ğŸ“ MinIO: http://localhost:9001"
	@echo "ğŸŒ API: http://localhost:8080"
	@echo "ğŸ” Health: http://localhost:8080/health"

dev-redis: redis-start cache-warmup ## Environnement dev avec Redis optimisÃ©
	@echo "ğŸš€ Environnement Redis prÃªt !"
	@echo "ğŸ”´ Redis: localhost:6379"
	@echo "ğŸ“Š Cache Stats: http://localhost:8080/api/v1/cache/stats"
	@echo "ğŸ›ï¸  Monitoring: http://localhost:8080/api/v1/monitoring/redis"

dev-full: ## Environnement dÃ©veloppement complet avec monitoring
	@echo "ğŸš€ Environnement complet avec monitoring..."
	@$(DOCKER_COMPOSE) --profile monitoring up -d
	@make cache-warmup
	@echo "âœ… Environnement complet prÃªt !"
	@echo "ğŸ“Š Services disponibles :"
	@echo "  ğŸŒ API: http://localhost:8080"
	@echo "  ğŸ”´ Redis Commander: http://localhost:8081"
	@echo "  ğŸ“ˆ Prometheus: http://localhost:9090"
	@echo "  ğŸ“Š Grafana: http://localhost:3000"

monitor-all: redis-start redis-dashboard redis-monitor ## Monitoring complet
	@echo "ğŸ“Š Monitoring complet lancÃ©"

prod-deploy: ## DÃ©ploiement production
	@echo "ğŸ­ DÃ©ploiement production..."
	@echo "âš ï¸  VÃ©rifiez la configuration avant de continuer"
	@read -p "Continuer ? (y/N) " confirm && [ "$$confirm" = "y" ] || exit 1
	@$(DOCKER_COMPOSE) -f docker-compose.prod.yml up -d
	@make cache-warmup
	@echo "âœ… DÃ©ploiement production terminÃ©"

# ============================================
# ğŸ§¹ MAINTENANCE
# ============================================
.PHONY: logs logs-redis logs-app maintenance-mode

logs: ## Tous les logs
	@$(DOCKER_COMPOSE) logs -f

logs-redis: ## Logs Redis uniquement
	@$(DOCKER_COMPOSE) logs -f redis

logs-app: ## Logs application uniquement
	@$(DOCKER_COMPOSE) logs -f app

maintenance-mode: ## Mode maintenance
	@echo "ğŸš§ Activation mode maintenance..."
	@echo "âš ï¸  FonctionnalitÃ© Ã  implÃ©menter"

# ============================================
# ğŸ¯ DEFAULT
# ============================================
.DEFAULT_GOAL := help