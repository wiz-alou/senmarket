# ============================================
# Makefile
# ============================================
.PHONY: help build run test clean docker-up docker-down migrate

# Variables
APP_NAME := senmarket
DOCKER_COMPOSE := docker-compose
GO_FILES := $(shell find . -name "*.go" -type f)

help: ## Affiche l'aide
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-30s\033[0m %s\n", $$1, $$2}'

build: ## Compile l'application
	@echo "ğŸ”¨ Compilation de l'application..."
	@go build -o bin/$(APP_NAME) cmd/server/main.go

run: ## Lance l'application en mode dÃ©veloppement
	@echo "ğŸš€ Lancement de l'application..."
	@go run cmd/server/main.go

test: ## Lance les tests
	@echo "ğŸ§ª ExÃ©cution des tests..."
	@go test -v ./...

test-coverage: ## Lance les tests avec coverage
	@echo "ğŸ“Š Tests avec coverage..."
	@go test -coverprofile=coverage.out ./...
	@go tool cover -html=coverage.out -o coverage.html

clean: ## Nettoie les fichiers de build
	@echo "ğŸ§¹ Nettoyage..."
	@rm -rf bin/ tmp/ coverage.out coverage.html

docker-up: ## Lance les services Docker
	@echo "ğŸ³ Lancement des services Docker..."
	@$(DOCKER_COMPOSE) up -d

docker-down: ## ArrÃªte les services Docker
	@echo "ğŸ›‘ ArrÃªt des services Docker..."
	@$(DOCKER_COMPOSE) down

docker-logs: ## Affiche les logs Docker
	@$(DOCKER_COMPOSE) logs -f

migrate-up: ## Applique les migrations
	@echo "ğŸ“Š Application des migrations..."
	@migrate -path migrations -database "postgres://senmarket:senmarket123@localhost:5432/senmarket?sslmode=disable" up

migrate-down: ## Annule les migrations
	@echo "â†©ï¸ Annulation des migrations..."
	@migrate -path migrations -database "postgres://senmarket:senmarket123@localhost:5432/senmarket?sslmode=disable" down

migrate-create: ## CrÃ©e une nouvelle migration (usage: make migrate-create NAME=nom_migration)
	@migrate create -ext sql -dir migrations $(NAME)

deps: ## Installe les dÃ©pendances
	@echo "ğŸ“¦ Installation des dÃ©pendances..."
	@go mod tidy
	@go mod download

fmt: ## Formate le code
	@echo "âœ¨ Formatage du code..."
	@go fmt ./...

lint: ## Lance le linter
	@echo "ğŸ” Linting..."
	@golangci-lint run

dev: docker-up ## Lance l'environnement de dÃ©veloppement
	@echo "ğŸš€ Environnement de dÃ©veloppement prÃªt !"
	@echo "ğŸ“Š PostgreSQL: localhost:5432"
	@echo "ğŸ”´ Redis: localhost:6379"
	@echo "ğŸ“ MinIO: http://localhost:9001"

install-tools: ## Installe les outils de dÃ©veloppement
	@echo "ğŸ› ï¸ Installation des outils..."
	@go install github.com/cosmtrek/air@latest
	@go install -tags 'postgres' github.com/golang-migrate/migrate/v4/cmd/migrate@latest

air: ## Lance l'application avec hot reload
	@air