#!/bin/bash

# ============================================
# üî¥ SCRIPT DE VALIDATION REDIS COMPLET
# scripts/validate_redis_implementation.sh
# ============================================

echo "üî¥ Validation Impl√©mentation Redis SenMarket"
echo "============================================"

# Couleurs pour les logs
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Configuration
BASE_URL="http://localhost:8080"
API_URL="${BASE_URL}/api/v1"
REDIS_HOST="localhost"
REDIS_PORT="6379"

# Compteurs de tests
TESTS_TOTAL=0
TESTS_PASSED=0
TESTS_FAILED=0

# Fonction de test
run_test() {
    local test_name="$1"
    local test_command="$2"
    
    TESTS_TOTAL=$((TESTS_TOTAL + 1))
    echo -e "\n${BLUE}Test $TESTS_TOTAL: $test_name${NC}"
    
    if eval "$test_command"; then
        echo -e "${GREEN}‚úÖ PASS${NC}"
        TESTS_PASSED=$((TESTS_PASSED + 1))
        return 0
    else
        echo -e "${RED}‚ùå FAIL${NC}"
        TESTS_FAILED=$((TESTS_FAILED + 1))
        return 1
    fi
}

# ============================================
# TESTS DE CONNECTIVIT√â
# ============================================

echo -e "${YELLOW}üîå Tests de Connectivit√©${NC}"

run_test "Redis Connection" "redis-cli -h $REDIS_HOST -p $REDIS_PORT ping | grep -q PONG"

run_test "API Health Check" "curl -s $BASE_URL/health | jq -r '.checks.redis' | grep -q UP"

run_test "Database Connection" "curl -s $BASE_URL/health | jq -r '.checks.database' | grep -q UP"

# ============================================
# TESTS DE FONCTIONNALIT√â CACHE
# ============================================

echo -e "\n${YELLOW}üî¥ Tests de Fonctionnalit√© Cache${NC}"

# Nettoyer le cache pour les tests
redis-cli -h $REDIS_HOST -p $REDIS_PORT FLUSHALL > /dev/null 2>&1

run_test "Cache Categories (MISS)" "curl -s '${API_URL}/categories' -I | grep -q 'X-Cache: MISS'"

run_test "Cache Categories (HIT)" "curl -s '${API_URL}/categories' -I | grep -q 'X-Cache: HIT'"

run_test "Cache Listings Page" "curl -s '${API_URL}/listings?page=1&limit=5' > /dev/null && curl -s '${API_URL}/listings?page=1&limit=5' -I | grep -q 'X-Cache: HIT'"

run_test "Cache Search Results" "curl -s '${API_URL}/listings/search?q=test' > /dev/null && curl -s '${API_URL}/listings/search?q=test' -I | grep -q 'X-Cache: HIT'"

# ============================================
# TESTS RATE LIMITING
# ============================================

echo -e "\n${YELLOW}‚ö° Tests Rate Limiting${NC}"

# Fonction pour tester le rate limiting
test_rate_limit() {
    local endpoint="$1"
    local limit="$2"
    
    # Faire plusieurs requ√™tes rapidement
    for i in $(seq 1 $((limit + 5))); do
        status=$(curl -s -o /dev/null -w "%{http_code}" "$endpoint")
        if [ "$status" = "429" ]; then
            return 0  # Rate limiting fonctionne
        fi
        sleep 0.1
    done
    return 1  # Pas de rate limiting d√©tect√©
}

run_test "Rate Limiting Auth" "test_rate_limit '${API_URL}/auth/login' 10"

run_test "Rate Limiting Global" "for i in {1..105}; do curl -s '${API_URL}/categories' > /dev/null; done; curl -s '${API_URL}/categories' -I | grep -q '429'"

# ============================================
# TESTS DE PERFORMANCE
# ============================================

echo -e "\n${YELLOW}üöÄ Tests de Performance${NC}"

# Test de latence cache
test_cache_performance() {
    # MISS (cache vide)
    redis-cli -h $REDIS_HOST -p $REDIS_PORT DEL "categories:all" > /dev/null 2>&1
    miss_time=$(curl -s -w "%{time_total}" -o /dev/null "${API_URL}/categories")
    
    # HIT (cache chaud)
    hit_time=$(curl -s -w "%{time_total}" -o /dev/null "${API_URL}/categories")
    
    # Calculer l'am√©lioration (en bash avec multiplication par 100)
    miss_ms=$(echo "$miss_time * 1000" | bc -l 2>/dev/null || echo "100")
    hit_ms=$(echo "$hit_time * 1000" | bc -l 2>/dev/null || echo "50")
    
    # Test simple : HIT doit √™tre plus rapide que MISS
    [ $(echo "$hit_time < $miss_time" | bc -l 2>/dev/null || echo "1") = "1" ]
}

run_test "Cache Performance Improvement" "test_cache_performance"

# Test de charge
test_concurrent_requests() {
# Test de charge
test_concurrent_requests() {
    echo "  Envoi de 20 requ√™tes simultan√©es..."
    
    # Lancer 20 requ√™tes en parall√®le
    for i in {1..20}; do
        curl -s "${API_URL}/categories" > /dev/null &
    done
    
    # Attendre que toutes se terminent
    wait
    
    # V√©rifier que Redis est toujours op√©rationnel
    redis-cli -h $REDIS_HOST -p $REDIS_PORT ping | grep -q PONG
}

run_test "Concurrent Requests Handling" "test_concurrent_requests"

# ============================================
# TESTS D'INVALIDATION DE CACHE
# ============================================

echo -e "\n${YELLOW}üîÑ Tests d'Invalidation de Cache${NC}"

# Simuler une cr√©ation d'annonce pour tester l'invalidation
test_cache_invalidation() {
    # R√©cup√©rer les listings (mise en cache)
    curl -s "${API_URL}/listings?page=1&limit=5" > /dev/null
    
    # V√©rifier que c'est en cache
    if curl -s "${API_URL}/listings?page=1&limit=5" -I | grep -q "X-Cache: HIT"; then
        # Simuler invalidation en supprimant manuellement la cl√©
        redis-cli -h $REDIS_HOST -p $REDIS_PORT DEL "listings:page:1:5" > /dev/null 2>&1
        
        # Le prochain appel doit √™tre MISS
        curl -s "${API_URL}/listings?page=1&limit=5" -I | grep -q "X-Cache: MISS"
    else
        return 1
    fi
}

run_test "Cache Invalidation" "test_cache_invalidation"

# ============================================
# TESTS DE PERSISTANCE REDIS
# ============================================

echo -e "\n${YELLOW}üíæ Tests de Persistance Redis${NC}"

test_redis_persistence() {
    # √âcrire une cl√© de test
    redis-cli -h $REDIS_HOST -p $REDIS_PORT SET "test:persistence" "working" EX 3600 > /dev/null 2>&1
    
    # Forcer une sauvegarde
    redis-cli -h $REDIS_HOST -p $REDIS_PORT BGSAVE > /dev/null 2>&1
    
    # V√©rifier que la cl√© existe
    redis-cli -h $REDIS_HOST -p $REDIS_PORT GET "test:persistence" | grep -q "working"
}

run_test "Redis Persistence" "test_redis_persistence"

# ============================================
# TESTS DE S√âCURIT√â
# ============================================

echo -e "\n${YELLOW}üîí Tests de S√©curit√©${NC}"

test_redis_security() {
    # Tester que Redis n'est pas accessible sans authentification
    # (Si un mot de passe est configur√©)
    redis-cli -h $REDIS_HOST -p $REDIS_PORT --no-auth-warning ping 2>&1 | grep -q "NOAUTH\|Authentication required\|PONG"
}

run_test "Redis Security" "test_redis_security"

# ============================================
# TESTS DE MONITORING
# ============================================

echo -e "\n${YELLOW}üìä Tests de Monitoring${NC}"

run_test "Cache Stats Endpoint" "curl -s '${API_URL}/cache/stats' | jq -r '.status' | grep -q 'OK'"

run_test "Memory Usage Check" "redis-cli -h $REDIS_HOST -p $REDIS_PORT INFO memory | grep -q 'used_memory_human'"

run_test "Key Count Check" "redis-cli -h $REDIS_HOST -p $REDIS_PORT DBSIZE | grep -q '[0-9]'"

# ============================================
# VALIDATION DES STRUCTURES DE CACHE
# ============================================

echo -e "\n${YELLOW}üèóÔ∏è  Tests de Structure de Cache${NC}"

test_cache_structure() {
    # G√©n√©rer du cache en appelant diff√©rents endpoints
    curl -s "${API_URL}/categories" > /dev/null
    curl -s "${API_URL}/listings?page=1&limit=5" > /dev/null
    curl -s "${API_URL}/listings/search?q=test" > /dev/null
    
    # V√©rifier que les cl√©s ont les bons patterns
    local categories_keys=$(redis-cli -h $REDIS_HOST -p $REDIS_PORT --scan --pattern "categories:*" | wc -l)
    local listings_keys=$(redis-cli -h $REDIS_HOST -p $REDIS_PORT --scan --pattern "listings:*" | wc -l)
    local search_keys=$(redis-cli -h $REDIS_HOST -p $REDIS_PORT --scan --pattern "search:*" | wc -l)
    
    [ "$categories_keys" -gt 0 ] && [ "$listings_keys" -gt 0 ] && [ "$search_keys" -gt 0 ]
}

run_test "Cache Key Structure" "test_cache_structure"

# ============================================
# TESTS DE TTL (TIME TO LIVE)
# ============================================

echo -e "\n${YELLOW}‚è∞ Tests TTL${NC}"

test_cache_ttl() {
    # V√©rifier qu'une cl√© a un TTL
    local key=$(redis-cli -h $REDIS_HOST -p $REDIS_PORT --scan --pattern "*" | head -1)
    if [ -n "$key" ]; then
        local ttl=$(redis-cli -h $REDIS_HOST -p $REDIS_PORT TTL "$key")
        # TTL > 0 signifie qu'un d√©lai d'expiration est d√©fini
        [ "$ttl" -gt 0 ] || [ "$ttl" -eq -1 ]  # -1 = pas d'expiration d√©finie (OK aussi)
    else
        # Cr√©er une cl√© temporaire pour tester
        redis-cli -h $REDIS_HOST -p $REDIS_PORT SET "test:ttl" "value" EX 300 > /dev/null 2>&1
        local ttl=$(redis-cli -h $REDIS_HOST -p $REDIS_PORT TTL "test:ttl")
        [ "$ttl" -gt 0 ]
    fi
}

run_test "Cache TTL Configuration" "test_cache_ttl"

# ============================================
# R√âSULTATS FINAUX
# ============================================

echo -e "\n${BLUE}============================================${NC}"
echo -e "${BLUE}üèÅ R√âSULTATS DE VALIDATION${NC}"
echo -e "${BLUE}============================================${NC}"

echo -e "Total des tests: $TESTS_TOTAL"
echo -e "${GREEN}Tests r√©ussis: $TESTS_PASSED${NC}"
echo -e "${RED}Tests √©chou√©s: $TESTS_FAILED${NC}"

# Calculer le pourcentage de r√©ussite
if [ $TESTS_TOTAL -gt 0 ]; then
    success_rate=$(( TESTS_PASSED * 100 / TESTS_TOTAL ))
    echo -e "Taux de r√©ussite: ${success_rate}%"
    
    if [ $success_rate -ge 90 ]; then
        echo -e "\n${GREEN}üéâ EXCELLENT ! Impl√©mentation Redis pr√™te pour la production !${NC}"
        exit_code=0
    elif [ $success_rate -ge 75 ]; then
        echo -e "\n${YELLOW}‚ö†Ô∏è  BON ! Quelques am√©liorations mineures n√©cessaires.${NC}"
        exit_code=0
    else
        echo -e "\n${RED}‚ùå PROBL√àMES D√âTECT√âS ! R√©vision n√©cessaire avant production.${NC}"
        exit_code=1
    fi
else
    echo -e "\n${RED}‚ùå ERREUR ! Aucun test n'a pu √™tre ex√©cut√©.${NC}"
    exit_code=1
fi

# Informations suppl√©mentaires
if [ $TESTS_FAILED -gt 0 ]; then
    echo -e "\n${YELLOW}üí° Conseils de d√©pannage :${NC}"
    echo -e "‚Ä¢ V√©rifiez que Redis est d√©marr√© : redis-cli ping"
    echo -e "‚Ä¢ V√©rifiez que l'API SenMarket est d√©marr√©e : curl $BASE_URL/health"
    echo -e "‚Ä¢ Consultez les logs : docker-compose logs redis"
    echo -e "‚Ä¢ V√©rifiez la configuration Redis dans .env"
fi

echo -e "\n${BLUE}üìä Statistiques Redis actuelles :${NC}"
if redis-cli -h $REDIS_HOST -p $REDIS_PORT ping > /dev/null 2>&1; then
    total_keys=$(redis-cli -h $REDIS_HOST -p $REDIS_PORT DBSIZE)
    memory_used=$(redis-cli -h $REDIS_HOST -p $REDIS_PORT INFO memory | grep "used_memory_human" | cut -d: -f2 | tr -d '\r')
    echo -e "‚Ä¢ Cl√©s en cache: $total_keys"
    echo -e "‚Ä¢ M√©moire utilis√©e: $memory_used"
    
    # Hit ratio si disponible
    hits=$(redis-cli -h $REDIS_HOST -p $REDIS_PORT INFO stats | grep "keyspace_hits:" | cut -d: -f2 | tr -d '\r')
    misses=$(redis-cli -h $REDIS_HOST -p $REDIS_PORT INFO stats | grep "keyspace_misses:" | cut -d: -f2 | tr -d '\r')
    
    if [ -n "$hits" ] && [ -n "$misses" ] && [ $((hits + misses)) -gt 0 ]; then
        hit_ratio=$(( hits * 100 / (hits + misses) ))
        echo -e "‚Ä¢ Hit ratio: ${hit_ratio}%"
    fi
fi

exit $exit_code