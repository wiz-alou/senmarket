# ============================================
# Makefile - SENMARKET AVEC REDIS + MINIO
# ============================================

# Variables
APP_NAME := senmarket
DOCKER_COMPOSE := docker-compose
GO_FILES := $(shell find . -name "*.go" -type f)
REDIS_HOST := localhost
REDIS_PORT := 6379
REDIS_PASSWORD := 
MINIO_HOST := localhost
MINIO_PORT := 9000
MINIO_CONSOLE_PORT := 9001
DB_URL := postgres://senmarket:senmarket123@localhost:5432/senmarket?sslmode=disable

# ============================================
# üìã AIDE
# ============================================
.PHONY: help
help: ## Affiche l'aide
	@echo "üá∏üá≥ SenMarket - Commandes Disponibles"
	@echo "===================================="
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-30s\033[0m %s\n", $$1, $$2}'
	@echo ""
	@echo "üî¥ Commandes Redis sp√©cialis√©es :"
	@echo "  make redis-start        - D√©marre Redis"
	@echo "  make redis-test         - Tests Redis complets"
	@echo "  make redis-monitor      - Monitoring temps r√©el"
	@echo "  make redis-dashboard    - Dashboard web"
	@echo "  make cache-warmup       - Pr√©chauffage cache"
	@echo ""
	@echo "üìÅ Commandes MinIO sp√©cialis√©es :"
	@echo "  make minio-start        - D√©marre MinIO"
	@echo "  make minio-test         - Tests MinIO complets"
	@echo "  make minio-console      - Console web MinIO"
	@echo "  make minio-backup       - Backup images"
	@echo "  make migrate-to-minio   - Migration vers MinIO"
	@echo ""
	@echo "üöÄ Commandes rapides :"
	@echo "  make dev                - Environnement complet"
	@echo "  make dev-redis          - Dev avec Redis"
	@echo "  make dev-minio          - Dev avec MinIO"
	@echo "  make monitor-all        - Monitoring complet"

# ============================================
# üî® BUILD & RUN
# ============================================
.PHONY: build run test test-coverage clean fmt lint deps

build: ## Compile l'application
	@echo "üî® Compilation de l'application..."
	@go build -o bin/$(APP_NAME) cmd/server/main.go
	@echo "‚úÖ Application compil√©e dans bin/$(APP_NAME)"

run: ## Lance l'application en mode d√©veloppement
	@echo "üöÄ Lancement de l'application..."
	@go run cmd/server/main.go

test: ## Lance les tests
	@echo "üß™ Ex√©cution des tests..."
	@go test -v ./...

test-minio: ## Tests MinIO sp√©cifiques
	@echo "üìÅ Tests MinIO..."
	@go test -v ./internal/services/ -run TestMinIO

test-coverage: ## Lance les tests avec coverage
	@echo "üìä Tests avec coverage..."
	@go test -coverprofile=coverage.out ./...
	@go tool cover -html=coverage.out -o coverage.html
	@echo "üìä Coverage report: coverage.html"

clean: ## Nettoie les fichiers de build
	@echo "üßπ Nettoyage..."
	@rm -rf bin/ tmp/ coverage.out coverage.html
	@echo "‚úÖ Nettoyage termin√©"

fmt: ## Formate le code
	@echo "‚ú® Formatage du code..."
	@go fmt ./...
	@echo "‚úÖ Code format√©"

lint: ## Lance le linter
	@echo "üîç Linting..."
	@golangci-lint run
	@echo "‚úÖ Linting termin√©"

deps: ## Installe les d√©pendances
	@echo "üì¶ Installation des d√©pendances..."
	@go mod tidy
	@go mod download
	@echo "‚úÖ D√©pendances install√©es"

deps-minio: ## Ajoute les d√©pendances MinIO
	@echo "üìÅ Ajout d√©pendances MinIO..."
	@go get github.com/minio/minio-go/v7
	@go mod tidy
	@echo "‚úÖ D√©pendances MinIO ajout√©es"

# ============================================
# üê≥ DOCKER
# ============================================
.PHONY: docker-up docker-down docker-logs docker-build docker-clean

docker-up: ## Lance les services Docker
	@echo "üê≥ Lancement des services Docker..."
	@$(DOCKER_COMPOSE) up -d
	@echo "‚úÖ Services Docker d√©marr√©s"
	@echo "üîç Health check: http://localhost:8080/health"

docker-down: ## Arr√™te les services Docker
	@echo "üõë Arr√™t des services Docker..."
	@$(DOCKER_COMPOSE) down
	@echo "‚úÖ Services Docker arr√™t√©s"

docker-logs: ## Affiche les logs Docker
	@$(DOCKER_COMPOSE) logs -f

docker-build: ## Rebuild les images Docker
	@echo "üî® Rebuild des images Docker..."
	@$(DOCKER_COMPOSE) build --no-cache
	@echo "‚úÖ Images Docker rebuilt"

docker-clean: ## Nettoie Docker compl√®tement
	@echo "üßπ Nettoyage Docker..."
	@$(DOCKER_COMPOSE) down -v --remove-orphans
	@docker system prune -f
	@echo "‚úÖ Docker nettoy√©"

# ============================================
# üî¥ REDIS CORE
# ============================================
.PHONY: redis-start redis-stop redis-restart redis-status redis-cli

redis-start: ## D√©marre Redis
	@echo "üî¥ D√©marrage Redis..."
	@$(DOCKER_COMPOSE) up redis -d
	@echo "‚úÖ Redis d√©marr√©"
	@echo "üîó Redis: $(REDIS_HOST):$(REDIS_PORT)"

redis-stop: ## Arr√™te Redis
	@echo "üî¥ Arr√™t Redis..."
	@$(DOCKER_COMPOSE) stop redis
	@echo "‚úÖ Redis arr√™t√©"

redis-restart: ## Red√©marre Redis
	@echo "üîÑ Red√©marrage Redis..."
	@$(DOCKER_COMPOSE) restart redis
	@echo "‚úÖ Redis red√©marr√©"

redis-status: ## Status Redis
	@echo "üî¥ Status Redis..."
	@docker exec senmarket_redis redis-cli ping || echo "‚ùå Redis non accessible"
	@echo "üìä Infos Redis:"
	@docker exec senmarket_redis redis-cli info server | grep redis_version || true
	@docker exec senmarket_redis redis-cli dbsize || true

redis-cli: ## Console Redis interactive
	@echo "üî¥ Console Redis (tapez 'exit' pour quitter)..."
	@docker exec -it senmarket_redis redis-cli

# ============================================
# üìÅ MINIO CORE
# ============================================
.PHONY: minio-start minio-stop minio-restart minio-status minio-console

minio-start: ## D√©marre MinIO
	@echo "üìÅ D√©marrage MinIO..."
	@$(DOCKER_COMPOSE) up minio -d
	@echo "‚úÖ MinIO d√©marr√©"
	@echo "üîó MinIO API: http://$(MINIO_HOST):$(MINIO_PORT)"
	@echo "üéõÔ∏è  MinIO Console: http://$(MINIO_HOST):$(MINIO_CONSOLE_PORT)"
	@echo "üë§ Login: senmarket / senmarket123"

minio-stop: ## Arr√™te MinIO
	@echo "üìÅ Arr√™t MinIO..."
	@$(DOCKER_COMPOSE) stop minio
	@echo "‚úÖ MinIO arr√™t√©"

minio-restart: ## Red√©marre MinIO
	@echo "üîÑ Red√©marrage MinIO..."
	@$(DOCKER_COMPOSE) restart minio
	@echo "‚úÖ MinIO red√©marr√©"

minio-status: ## Status MinIO
	@echo "üìÅ Status MinIO..."
	@curl -f http://$(MINIO_HOST):$(MINIO_PORT)/minio/health/live > /dev/null 2>&1 && echo "‚úÖ MinIO UP" || echo "‚ùå MinIO DOWN"
	@echo "üìä Infos MinIO:"
	@curl -s http://localhost:8080/api/v1/storage/status | jq . 2>/dev/null || echo "‚ö†Ô∏è  API non accessible"

minio-console: ## Ouvre la console MinIO
	@echo "üìÅ Ouverture console MinIO..."
	@echo "üåê URL: http://$(MINIO_HOST):$(MINIO_CONSOLE_PORT)"
	@echo "üë§ User: senmarket"
	@echo "üîë Pass: senmarket123"
	@command -v open >/dev/null 2>&1 && open http://$(MINIO_HOST):$(MINIO_CONSOLE_PORT) || \
	 command -v xdg-open >/dev/null 2>&1 && xdg-open http://$(MINIO_HOST):$(MINIO_CONSOLE_PORT) || \
	 echo "Ouvrez manuellement: http://$(MINIO_HOST):$(MINIO_CONSOLE_PORT)"

minio-create-bucket: ## Cr√©e le bucket principal
	@echo "üìÅ Cr√©ation bucket senmarket-images..."
	@docker exec senmarket_minio mc mb /data/senmarket-images --ignore-existing
	@docker exec senmarket_minio mc anonymous set public /data/senmarket-images
	@echo "‚úÖ Bucket cr√©√© et configur√© en public"

# ============================================
# üß™ REDIS TESTING
# ============================================
.PHONY: redis-test redis-test-short redis-perf redis-benchmark

redis-test: ## Tests Redis complets (15+ scenarios)
	@echo "üî¥ Tests Redis complets..."
	@chmod +x scripts/validate_redis_implementation.sh
	@./scripts/validate_redis_implementation.sh

redis-test-short: ## Tests Redis rapides
	@echo "üî¥ Tests Redis rapides..."
	@echo "1. Test connexion..."
	@curl -s http://localhost:8080/health | grep -q "redis.*UP" && echo "‚úÖ Redis UP" || echo "‚ùå Redis DOWN"
	@echo "2. Test cache..."
	@curl -s http://localhost:8080/api/v1/categories > /dev/null && echo "‚úÖ Cache fonctionnel" || echo "‚ùå Cache KO"
	@echo "3. Test rate limiting..."
	@for i in {1..5}; do curl -s http://localhost:8080/api/v1/categories > /dev/null; done && echo "‚úÖ Rate limiting OK" || echo "‚ùå Rate limiting KO"

redis-perf: ## Tests performance Redis
	@echo "üî• Tests performance Redis..."
	@chmod +x scripts/redis_performance_test.sh
	@./scripts/redis_performance_test.sh

redis-benchmark: ## Benchmark Redis natif
	@echo "‚ö° Benchmark Redis..."
	@docker exec senmarket_redis redis-benchmark -q -n 1000 -c 10

# ============================================
# üß™ MINIO TESTING
# ============================================
.PHONY: minio-test minio-test-upload minio-test-download minio-benchmark

minio-test: ## Tests MinIO complets
	@echo "üìÅ Tests MinIO complets..."
	@echo "1. Test connexion..."
	@curl -s http://localhost:8080/health | grep -q "minio.*UP" && echo "‚úÖ MinIO UP" || echo "‚ùå MinIO DOWN"
	@echo "2. Test API status..."
	@curl -s http://localhost:8080/api/v1/storage/status > /dev/null && echo "‚úÖ Storage API OK" || echo "‚ùå Storage API KO"
	@echo "3. Test bucket..."
	@curl -f http://$(MINIO_HOST):$(MINIO_PORT)/senmarket-images/ > /dev/null 2>&1 && echo "‚úÖ Bucket accessible" || echo "‚ùå Bucket KO"
	@echo "4. Tests unitaires..."
	@make test-minio

minio-test-upload: ## Test upload d'une image de test
	@echo "üìÅ Test upload image..."
	@echo "iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg==" | base64 -d > test_image.png
	@curl -X POST -F "image=@test_image.png" \
		-H "Authorization: Bearer test-token" \
		http://localhost:8080/api/v1/images/upload > /dev/null 2>&1 && \
		echo "‚úÖ Upload test OK" || echo "‚ùå Upload test KO (auth required)"
	@rm -f test_image.png

minio-test-download: ## Test t√©l√©chargement d'images
	@echo "üìÅ Test acc√®s images..."
	@curl -f http://$(MINIO_HOST):$(MINIO_PORT)/senmarket-images/ > /dev/null 2>&1 && \
		echo "‚úÖ Images accessibles" || echo "‚ùå Images non accessibles"

minio-benchmark: ## Benchmark MinIO
	@echo "‚ö° Benchmark MinIO..."
	@echo "üìä Test performance upload/download..."
	@for i in {1..10}; do \
		echo "Test image $$i" | curl -X POST -F "data=@-" http://$(MINIO_HOST):$(MINIO_PORT)/senmarket-images/test$$i.txt > /dev/null 2>&1; \
	done
	@echo "‚úÖ Benchmark termin√©"

# ============================================
# üìä REDIS MONITORING
# ============================================
.PHONY: redis-monitor redis-stats redis-keys redis-memory redis-dashboard

redis-monitor: ## Monitoring Redis temps r√©el
	@echo "üî¥ Monitoring Redis temps r√©el..."
	@chmod +x scripts/redis_monitor.sh
	@./scripts/redis_monitor.sh

redis-stats: ## Statistiques Redis
	@echo "üìä Statistiques Redis..."
	@echo "üîë Nombre de cl√©s:"
	@docker exec senmarket_redis redis-cli dbsize
	@echo "üíæ M√©moire utilis√©e:"
	@docker exec senmarket_redis redis-cli info memory | grep used_memory_human
	@echo "üìà Hit ratio:"
	@docker exec senmarket_redis redis-cli info stats | grep keyspace_hits
	@docker exec senmarket_redis redis-cli info stats | grep keyspace_misses

redis-keys: ## Voir les cl√©s Redis par pattern
	@echo "üîë Cl√©s Redis par type..."
	@echo "üìã Listings: $$(docker exec senmarket_redis redis-cli --scan --pattern 'listing:*' | wc -l)"
	@echo "üìÇ Categories: $$(docker exec senmarket_redis redis-cli --scan --pattern 'category:*' | wc -l)"
	@echo "üîç Searches: $$(docker exec senmarket_redis redis-cli --scan --pattern 'search:*' | wc -l)"
	@echo "üë§ Users: $$(docker exec senmarket_redis redis-cli --scan --pattern 'user:*' | wc -l)"
	@echo "üìä Stats: $$(docker exec senmarket_redis redis-cli --scan --pattern 'stats:*' | wc -l)"

redis-memory: ## Analyse m√©moire Redis
	@echo "üíæ Analyse m√©moire Redis..."
	@docker exec senmarket_redis redis-cli info memory

redis-dashboard: ## Dashboard Redis web
	@echo "üìä Ouverture dashboard Redis..."
	@echo "üåê Dashboard disponible √†: file://$(PWD)/scripts/redis_dashboard.html"
	@echo "üöÄ D√©marrage serveur web local..."
	@python3 -m http.server 8082 -d scripts/ > /dev/null 2>&1 &
	@sleep 2
	@echo "üìä Dashboard: http://localhost:8082/redis_dashboard.html"
	@echo "üí° Appuyez sur Ctrl+C pour arr√™ter le serveur"

# ============================================
# üìä MINIO MONITORING
# ============================================
.PHONY: minio-monitor minio-stats minio-info minio-objects

minio-monitor: ## Monitoring MinIO
	@echo "üìÅ Monitoring MinIO..."
	@echo "üìä Status: $$(curl -s http://localhost:8080/api/v1/storage/status | jq -r '.status' 2>/dev/null || echo 'N/A')"
	@echo "üìÅ Bucket: $$(curl -s http://localhost:8080/api/v1/storage/status | jq -r '.main_bucket.name' 2>/dev/null || echo 'N/A')"
	@echo "üî¢ Objects: $$(curl -s http://localhost:8080/api/v1/monitoring/minio | jq -r '.buckets.main_bucket.objects' 2>/dev/null || echo 'N/A')"

minio-stats: ## Statistiques MinIO
	@echo "üìä Statistiques MinIO..."
	@curl -s http://localhost:8080/api/v1/monitoring/minio | jq . 2>/dev/null || echo "‚ö†Ô∏è  API non accessible"

minio-info: ## Informations MinIO serveur
	@echo "üìÅ Informations MinIO..."
	@docker exec senmarket_minio mc admin info local 2>/dev/null || echo "‚ö†Ô∏è  MinIO admin non accessible"

minio-objects: ## Liste objets MinIO
	@echo "üìÅ Objets dans le bucket principal..."
	@docker exec senmarket_minio mc ls local/senmarket-images/ --recursive 2>/dev/null || echo "‚ö†Ô∏è  Bucket non accessible"

# ============================================
# üóÑÔ∏è REDIS CACHE MANAGEMENT
# ============================================
.PHONY: cache-warmup cache-clear cache-clear-pattern cache-info cache-backup

cache-warmup: ## Pr√©chauffage cache
	@echo "üî• Pr√©chauffage cache..."
	@go run scripts/cache_warmup.go
	@echo "‚úÖ Cache pr√©chauff√©"

cache-clear: ## Vide tout le cache Redis
	@echo "üßπ Nettoyage cache Redis..."
	@docker exec senmarket_redis redis-cli flushall
	@echo "‚úÖ Cache vid√©"

cache-clear-pattern: ## Vide cache par pattern (usage: make cache-clear-pattern PATTERN=listing:*)
	@echo "üßπ Nettoyage cache pattern: $(PATTERN)"
	@docker exec senmarket_redis redis-cli eval "return redis.call('del', unpack(redis.call('keys', ARGV[1])))" 0 "$(PATTERN)"
	@echo "‚úÖ Pattern $(PATTERN) supprim√©"

cache-info: ## Informations cache
	@echo "‚ÑπÔ∏è  Informations cache Redis..."
	@curl -s http://localhost:8080/api/v1/cache/stats | jq . || echo "‚ö†Ô∏è  API non accessible"

cache-backup: ## Backup Redis
	@echo "üíæ Backup Redis..."
	@chmod +x scripts/redis_backup.sh
	@./scripts/redis_backup.sh

# ============================================
# üìÅ MINIO MANAGEMENT
# ============================================
.PHONY: minio-backup minio-restore migrate-to-minio minio-cleanup

minio-backup: ## Backup MinIO
	@echo "üíæ Backup MinIO..."
	@mkdir -p backups/minio/$(shell date +%Y%m%d_%H%M%S)
	@docker exec senmarket_minio mc mirror local/senmarket-images/ /tmp/backup-$(shell date +%Y%m%d_%H%M%S)/ 2>/dev/null || echo "‚ö†Ô∏è  Backup √©chou√©"
	@echo "‚úÖ Backup MinIO termin√©"

minio-restore: ## Restore MinIO (usage: make minio-restore BACKUP_DIR=backup_folder)
	@echo "üîÑ Restore MinIO depuis: $(BACKUP_DIR)"
	@docker exec senmarket_minio mc mirror /tmp/$(BACKUP_DIR)/ local/senmarket-images/ 2>/dev/null || echo "‚ö†Ô∏è  Restore √©chou√©"
	@echo "‚úÖ Restore MinIO termin√©"

migrate-to-minio: ## Migration images locales vers MinIO
	@echo "üìÅ‚û°Ô∏èüìÅ Migration vers MinIO..."
	@echo "‚ö†Ô∏è  Assurez-vous que MinIO est d√©marr√©"
	@go run scripts/migrate_to_minio.go
	@echo "‚úÖ Migration termin√©e"

minio-cleanup: ## Nettoyage objets orphelins MinIO
	@echo "üßπ Nettoyage MinIO..."
	@echo "‚ö†Ô∏è  Suppression objets orphelins en cours..."
	@docker exec senmarket_minio mc rm local/senmarket-images/temp/ --recursive --force 2>/dev/null || true
	@echo "‚úÖ Nettoyage termin√©"

# ============================================
# üóÉÔ∏è DATABASE MIGRATIONS
# ============================================
.PHONY: migrate-up migrate-down migrate-create migrate-reset migrate-redis

migrate-up: ## Applique les migrations
	@echo "üìä Application des migrations..."
	@migrate -path migrations -database "$(DB_URL)" up
	@echo "‚úÖ Migrations appliqu√©es"

migrate-down: ## Annule les migrations
	@echo "‚Ü©Ô∏è  Annulation des migrations..."
	@migrate -path migrations -database "$(DB_URL)" down
	@echo "‚úÖ Migrations annul√©es"

migrate-create: ## Cr√©e une nouvelle migration (usage: make migrate-create NAME=nom_migration)
	@echo "üìù Cr√©ation migration: $(NAME)"
	@migrate create -ext sql -dir migrations $(NAME)
	@echo "‚úÖ Migration cr√©√©e"

migrate-reset: ## Reset complet DB + migrations
	@echo "üîÑ Reset complet base de donn√©es..."
	@$(DOCKER_COMPOSE) down postgres
	@docker volume rm senmarket_postgres_data || true
	@$(DOCKER_COMPOSE) up postgres -d
	@sleep 5
	@make migrate-up
	@echo "‚úÖ Base de donn√©es reset"

migrate-redis: ## Applique les optimisations Redis DB
	@echo "üî¥ Application optimisations Redis..."
	@migrate -path migrations -database "$(DB_URL)" up
	@echo "‚úÖ Optimisations Redis appliqu√©es"

# ============================================
# üõ†Ô∏è TOOLS & SETUP
# ============================================
.PHONY: install-tools setup-dev setup-prod

install-tools: ## Installe les outils de d√©veloppement
	@echo "üõ†Ô∏è  Installation des outils..."
	@go install github.com/cosmtrek/air@latest
	@go install -tags 'postgres' github.com/golang-migrate/migrate/v4/cmd/migrate@latest
	@echo "‚úÖ Outils install√©s"

setup-dev: ## Setup environnement d√©veloppement
	@echo "üöÄ Setup environnement d√©veloppement..."
	@make install-tools
	@make deps
	@make deps-minio
	@echo "üìÅ Cr√©ation dossiers..."
	@mkdir -p uploads backups/redis backups/minio scripts logs
	@echo "üîß Configuration .env..."
	@cp .env.example .env 2>/dev/null || echo "‚ö†Ô∏è  .env.example non trouv√©"
	@echo "‚úÖ Environnement dev pr√™t"

setup-prod: ## Setup environnement production
	@echo "üè≠ Setup environnement production..."
	@echo "üîí Configuration s√©curit√©..."
	@echo "‚ö†Ô∏è  Assurez-vous de configurer :"
	@echo "  - Variables d'environnement s√©curis√©es"
	@echo "  - Certificats SSL"
	@echo "  - Firewall"
	@echo "  - Monitoring"
	@echo "  - Backup automatique MinIO"

# ============================================
# üîÑ HOT RELOAD
# ============================================
.PHONY: air dev-watch

air: ## Lance l'application avec hot reload
	@echo "üî• D√©marrage hot reload..."
	@air

dev-watch: ## D√©veloppement avec watch des fichiers
	@echo "üëÄ Mode d√©veloppement avec watch..."
	@make docker-up
	@make air

# ============================================
# üöÄ ENVIRONNEMENTS COMBIN√âS
# ============================================
.PHONY: dev dev-redis dev-minio dev-full monitor-all prod-deploy

dev: docker-up ## Lance l'environnement de d√©veloppement
	@echo "üöÄ Environnement de d√©veloppement pr√™t !"
	@echo "üìä PostgreSQL: localhost:5432"
	@echo "üî¥ Redis: localhost:6379"
	@echo "üìÅ MinIO API: http://localhost:9000"
	@echo "üéõÔ∏è  MinIO Console: http://localhost:9001"
	@echo "üåê API: http://localhost:8080"
	@echo "üîç Health: http://localhost:8080/health"

dev-redis: redis-start cache-warmup ## Environnement dev avec Redis optimis√©
	@echo "üöÄ Environnement Redis pr√™t !"
	@echo "üî¥ Redis: localhost:6379"
	@echo "üìä Cache Stats: http://localhost:8080/api/v1/cache/stats"
	@echo "üéõÔ∏è  Monitoring: http://localhost:8080/api/v1/monitoring/redis"

dev-minio: minio-start minio-create-bucket ## Environnement dev avec MinIO optimis√©
	@echo "üöÄ Environnement MinIO pr√™t !"
	@echo "üìÅ MinIO API: http://localhost:9000"
	@echo "üéõÔ∏è  MinIO Console: http://localhost:9001"
	@echo "üìä Storage Status: http://localhost:8080/api/v1/storage/status"
	@echo "üéõÔ∏è  Monitoring: http://localhost:8080/api/v1/monitoring/minio"

dev-full: ## Environnement d√©veloppement complet avec monitoring
	@echo "üöÄ Environnement complet avec monitoring..."
	@$(DOCKER_COMPOSE) --profile monitoring up -d
	@make cache-warmup
	@make minio-create-bucket
	@echo "‚úÖ Environnement complet pr√™t !"
	@echo "üìä Services disponibles :"
	@echo "  üåê API: http://localhost:8080"
	@echo "  üî¥ Redis Commander: http://localhost:8081"
	@echo "  üìÅ MinIO Console: http://localhost:9001"
	@echo "  üìà Prometheus: http://localhost:9090"
	@echo "  üìä Grafana: http://localhost:3000"

monitor-all: redis-start minio-start redis-dashboard minio-monitor ## Monitoring complet
	@echo "üìä Monitoring complet lanc√©"

prod-deploy: ## D√©ploiement production
	@echo "üè≠ D√©ploiement production..."
	@echo "‚ö†Ô∏è  V√©rifiez la configuration avant de continuer"
	@read -p "Continuer ? (y/N) " confirm && [ "$$confirm" = "y" ] || exit 1
	@$(DOCKER_COMPOSE) -f docker-compose.prod.yml up -d
	@make cache-warmup
	@make minio-create-bucket
	@echo "‚úÖ D√©ploiement production termin√©"

# ============================================
# üßπ MAINTENANCE
# ============================================
.PHONY: logs logs-redis logs-minio logs-app maintenance-mode

logs: ## Tous les logs
	@$(DOCKER_COMPOSE) logs -f

logs-redis: ## Logs Redis uniquement
	@$(DOCKER_COMPOSE) logs -f redis

logs-minio: ## Logs MinIO uniquement
	@$(DOCKER_COMPOSE) logs -f minio

logs-app: ## Logs application uniquement
	@$(DOCKER_COMPOSE) logs -f app

maintenance-mode: ## Mode maintenance
	@echo "üöß Activation mode maintenance..."
	@echo "‚ö†Ô∏è  Fonctionnalit√© √† impl√©menter"

# ============================================
# üéØ QUICK COMMANDS
# ============================================
.PHONY: quick-start quick-test health-check

quick-start: ## D√©marrage rapide complet
	@echo "üöÄ D√©marrage rapide SenMarket..."
	@make dev
	@sleep 10
	@make cache-warmup
	@make minio-create-bucket
	@make health-check
	@echo "üéâ SenMarket est pr√™t!"

quick-test: ## Tests rapides tous services
	@echo "üß™ Tests rapides..."
	@make redis-test-short
	@make minio-test
	@echo "‚úÖ Tests rapides termin√©s"

health-check: ## V√©rification sant√© compl√®te
	@echo "ü©∫ V√©rification sant√© des services..."
	@curl -s http://localhost:8080/health | jq '.checks' 2>/dev/null || echo "‚ùå API non accessible"

# ============================================
# üéØ DEFAULT
# ============================================
.DEFAULT_GOAL := help